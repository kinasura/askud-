{% extends "admin_base.html" %}

{% block title %}Отчёты - АСКУД Админ{% endblock %}

{% block page_title %}Управление отчётами{% endblock %}
{% block page_subtitle %}Создание, просмотр и экспорт отчётов системы{% endblock %}

{% block page_actions %}
<button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createReportModal">
    <i class="bi bi-plus-circle"></i> Новый отчёт
</button>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Быстрое создание отчётов -->
    <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Быстрые отчёты
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary text-start" onclick="generateReport('daily')">
                        <i class="bi bi-calendar-day"></i> Отчёт за сегодня
                    </button>
                    <button class="btn btn-outline-success text-start" onclick="generateReport('weekly')">
                        <i class="bi bi-calendar-week"></i> Отчёт за неделю
                    </button>
                    <button class="btn btn-outline-warning text-start" onclick="generateReport('monthly')">
                        <i class="bi bi-calendar-month"></i> Отчёт за месяц
                    </button>
                    <button class="btn btn-outline-danger text-start" data-bs-toggle="modal" data-bs-target="#createReportModal">
                        <i class="bi bi-calendar-range"></i> Произвольный период
                    </button>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <small>
                        Отчёты сохраняются в базе данных и доступны для скачивания в форматах CSV и Excel.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Список созданных отчётов -->
    <div class="col-md-8 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> История отчётов
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshReports()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                {% if reports %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Период</th>
                                <th>Создан</th>
                                <th>Автор</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            {% for report in reports %}
                            <tr>
                                <td>
                                    <strong>{{ report.name }}</strong>
                                </td>
                                <td>
                                    {% if report.report_type == 'daily' %}
                                        <span class="badge bg-primary">Дневной</span>
                                    {% elif report.report_type == 'weekly' %}
                                        <span class="badge bg-success">Недельный</span>
                                    {% elif report.report_type == 'monthly' %}
                                        <span class="badge bg-warning">Месячный</span>
                                    {% elif report.report_type == 'custom' %}
                                        <span class="badge bg-info">Произвольный</span>
                                    {% elif report.report_type == 'export' %}
                                        <span class="badge bg-secondary">Экспорт</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if report.period_start %}
                                        {{ report.period_start }} 
                                        {% if report.period_end and report.period_end != report.period_start %}
                                            - {{ report.period_end }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Не указан</span>
                                    {% endif %}
                                </td>
                                <td>{{ report.generated_at[:16] }}</td>
                                <td>{{ report.created_by_name or 'Система' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="#" class="btn btn-outline-primary" 
                                           onclick="downloadReport({{ report.id }}, 'csv')">
                                            <i class="bi bi-filetype-csv"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteReport({{ report.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #6c757d;"></i>
                    <h5 class="mt-3">Нет созданных отчётов</h5>
                    <p class="text-muted">Создайте первый отчёт, используя кнопки слева</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <small class="text-muted">
                    Показано {{ reports|length }} отчётов
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Экспорт статистики -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="bi bi-download"></i> Экспорт данных
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-filetype-csv" style="font-size: 2.5rem; color: #28a745;"></i>
                        </div>
                        <h5>CSV Экспорт</h5>
                        <p class="small text-muted">Экспорт данных в формате CSV для анализа в Excel</p>
                        <div class="d-grid gap-2">
                            <a href="/api/admin/export/csv" class="btn btn-success">
                                <i class="bi bi-download"></i> Экспорт CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-filetype-xlsx" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5>Excel Экспорт</h5>
                        <p class="small text-muted">Экспорт данных в формате Excel с форматированием</p>
                        <button class="btn btn-primary" onclick="exportToExcel()">
                            <i class="bi bi-download"></i> Экспорт Excel
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-filetype-pdf" style="font-size: 2.5rem; color: #dc3545;"></i>
                        </div>
                        <h5>PDF Экспорт</h5>
                        <p class="small text-muted">Экспорт отчётов в PDF с графиками и таблицами</p>
                        <button class="btn btn-danger" onclick="exportToPDF()">
                            <i class="bi bi-download"></i> Экспорт PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-warning mt-3">
            <i class="bi bi-exclamation-triangle"></i>
            <small>
                <strong>Внимание:</strong> Экспорт больших объёмов данных может занять некоторое время. 
                Рекомендуется экспортировать данные по периодам.
            </small>
        </div>
    </div>
</div>

<!-- Модальное окно создания отчёта -->
<div class="modal fade" id="createReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-text"></i> Создание отчёта
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label">Название отчёта</label>
                        <input type="text" class="form-control" id="reportName" 
                               placeholder="Например: Отчёт за январь 2025">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Тип отчёта</label>
                        <select class="form-select" id="reportType" onchange="toggleDateFields()">
                            <option value="daily">Дневной</option>
                            <option value="weekly">Недельный</option>
                            <option value="monthly">Месячный</option>
                            <option value="custom">Произвольный период</option>
                        </select>
                    </div>
                    
                    <div class="row" id="dateFields" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Дата начала</label>
                            <input type="date" class="form-control" id="dateStart">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Дата окончания</label>
                            <input type="date" class="form-control" id="dateEnd">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Формат экспорта</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV</option>
                            <option value="excel">Excel (XLSX)</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            Дневной отчёт содержит события за сегодняшний день.<br>
                            Недельный отчёт - за последние 7 дней.<br>
                            Месячный отчёт - за текущий месяц.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createReport()">
                    <i class="bi bi-file-earmark-plus"></i> Создать
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно экспорта -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-download"></i> Экспорт данных
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="exportContent">
                    <!-- Контент для экспорта будет загружен здесь -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="exportDownloadBtn">
                    <i class="bi bi-download"></i> Скачать
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Обновление списка отчётов
    function refreshReports() {
        fetch('/api/admin/reports/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateReportsTable(data.reports);
                }
            });
    }
    
    // Обновление таблицы отчётов
    function updateReportsTable(reports) {
        const tbody = document.getElementById('reportsTableBody');
        if (!tbody) return;
        
        if (reports.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="bi bi-file-earmark-text" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="mt-2 mb-0">Нет созданных отчётов</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        const html = reports.map(report => {
            let typeBadge = '';
            switch(report.report_type) {
                case 'daily': typeBadge = '<span class="badge bg-primary">Дневной</span>'; break;
                case 'weekly': typeBadge = '<span class="badge bg-success">Недельный</span>'; break;
                case 'monthly': typeBadge = '<span class="badge bg-warning">Месячный</span>'; break;
                case 'custom': typeBadge = '<span class="badge bg-info">Произвольный</span>'; break;
                case 'export': typeBadge = '<span class="badge bg-secondary">Экспорт</span>'; break;
            }
            
            const period = report.period_start ? 
                `${report.period_start}${report.period_end && report.period_end !== report.period_start ? ' - ' + report.period_end : ''}` :
                '<span class="text-muted">Не указан</span>';
            
            return `
                <tr>
                    <td><strong>${report.name}</strong></td>
                    <td>${typeBadge}</td>
                    <td>${period}</td>
                    <td>${report.generated_at ? report.generated_at.slice(0, 16) : ''}</td>
                    <td>${report.created_by_name || 'Система'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="#" class="btn btn-outline-primary" 
                               onclick="downloadReport(${report.id}, 'csv')">
                                <i class="bi bi-filetype-csv"></i>
                            </a>
                            <button class="btn btn-outline-danger" 
                                    onclick="deleteReport(${report.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = html;
    }
    
    // Показать/скрыть поля дат
    function toggleDateFields() {
        const reportType = document.getElementById('reportType').value;
        const dateFields = document.getElementById('dateFields');
        dateFields.style.display = reportType === 'custom' ? 'block' : 'none';
    }
    
    // Создание отчёта
    function createReport() {
        const reportName = document.getElementById('reportName').value || 'Отчёт';
        const reportType = document.getElementById('reportType').value;
        const exportFormat = document.getElementById('exportFormat').value;
        
        const reportData = {
            name: reportName,
            type: reportType,
            format: exportFormat
        };
        
        if (reportType === 'custom') {
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            
            if (!dateStart || !dateEnd) {
                alert('Заполните даты для произвольного периода');
                return;
            }
            
            reportData.period_start = dateStart;
            reportData.period_end = dateEnd;
        }
        
        // Отправка запроса на создание отчёта
        fetch('/api/admin/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reportData)
        })
        .then(response => {
            if (exportFormat === 'csv') {
                return response.blob().then(blob => {
                    // Скачиваем CSV файл
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${reportName.replace(/\s+/g, '_')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Закрываем модальное окно
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createReportModal'));
                    modal.hide();
                    
                    // Обновляем список отчётов
                    refreshReports();
                });
            } else {
                return response.json().then(data => {
                    if (data.success) {
                        alert('Отчёт успешно создан');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createReportModal'));
                        modal.hide();
                        refreshReports();
                    } else {
                        alert('Ошибка: ' + data.message);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при создании отчёта');
        });
    }
    
    // Быстрое создание отчётов
    function generateReport(type) {
        let name = '';
        switch(type) {
            case 'daily': name = 'Отчёт за ' + new Date().toLocaleDateString('ru-RU'); break;
            case 'weekly': name = 'Недельный отчёт'; break;
            case 'monthly': name = 'Месячный отчёт'; break;
        }
        
        fetch('/api/admin/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: type,
                name: name
            })
        })
        .then(response => response.blob())
        .then(blob => {
            // Скачиваем файл
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/\s+/g, '_')}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Обновляем список отчётов
            setTimeout(refreshReports, 1000);
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при создании отчёта');
        });
    }
    
    // Скачивание отчёта
    function downloadReport(reportId, format) {
        // Временная заглушка - будет реализовано после создания API
        alert('Функция скачивания будет реализована на следующем этапе');
    }
    
    // Удаление отчёта
    function deleteReport(reportId) {
        if (confirm('Вы уверены, что хотите удалить этот отчёт?')) {
            fetch(`/api/admin/reports/${reportId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    refreshReports();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при удалении отчёта');
            });
        }
    }
    
    // Экспорт в Excel
    function exportToExcel() {
        fetch('/api/admin/export/excel')
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `askud_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Экспорт в Excel будет доступен после установки дополнительных библиотек');
            });
    }
    
    // Экспорт в PDF
    function exportToPDF() {
        // Покажем модальное окно с выбором опций для PDF
        const exportContent = document.getElementById('exportContent');
        exportContent.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Подготовка экспорта в PDF...</p>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('exportModal'));
        modal.show();
        
        // Имитируем загрузку
        setTimeout(() => {
            exportContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <p>Экспорт в PDF будет реализован на следующем этапе. Сейчас доступен экспорт в CSV и Excel.</p>
                    <p>Для создания PDF отчётов потребуется установка дополнительных библиотек.</p>
                </div>
                <div class="d-grid gap-2">
                    <a href="/api/admin/export/csv" class="btn btn-success">
                        <i class="bi bi-filetype-csv"></i> Экспортировать в CSV
                    </a>
                </div>
            `;
            
            document.getElementById('exportDownloadBtn').style.display = 'none';
        }, 1000);
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Установим сегодняшнюю дату как значение по умолчанию
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        document.getElementById('dateStart').value = weekAgo;
        document.getElementById('dateEnd').value = today;
        
        // Установим название отчёта по умолчанию
        document.getElementById('reportName').value = 'Отчёт от ' + new Date().toLocaleDateString('ru-RU');
        
        // Обновляем список отчётов каждые 30 секунд
        setInterval(refreshReports, 30000);
    });
</script>
{% endblock %}