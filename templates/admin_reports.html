{% extends "admin_base.html" %}

{% block title %}Отчёты - АСКУД Админ{% endblock %}

{% block page_title %}Управление отчётами{% endblock %}
{% block page_subtitle %}Создание, просмотр и экспорт отчётов системы{% endblock %}

{% block page_actions %}
<!-- Кнопка создания отчёта была здесь, теперь убрана -->
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">История отчётов</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
            <i class="bi bi-plus-circle"></i> Создать отчёт
        </button>
    </div>
</div>

<div class="row">
    <!-- Быстрое создание отчётов -->
    <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Быстрые отчёты
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createReportModal">
                    <i class="bi bi-plus-circle"></i> Новый отчёт
                </button>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary text-start" onclick="generateReport('daily')">
                        <i class="bi bi-calendar-day"></i> Отчёт за сегодня
                    </button>
                    <button class="btn btn-outline-success text-start" onclick="generateReport('weekly')">
                        <i class="bi bi-calendar-week"></i> Отчёт за неделю
                    </button>
                    <button class="btn btn-outline-warning text-start" onclick="generateReport('monthly')">
                        <i class="bi bi-calendar-month"></i> Отчёт за месяц
                    </button>
                    <button class="btn btn-outline-danger text-start" data-bs-toggle="modal" data-bs-target="#createReportModal">
                        <i class="bi bi-calendar-range"></i> Произвольный период
                    </button>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <small>
                        Отчёты сохраняются в базе данных и доступны для скачивания в форматах CSV и Excel.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Список созданных отчётов -->
    <div class="col-md-8 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> История отчётов
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshReports()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                {% if reports %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Период</th>
                                <th>Создан</th>
                                <th>Автор</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            {% for report in reports %}
                            <tr>
                                <td>
                                    <strong>{{ report.name }}</strong>
                                </td>
                                <td>
                                    {% if report.report_type == 'daily' %}
                                        <span class="badge bg-primary">Дневной</span>
                                    {% elif report.report_type == 'weekly' %}
                                        <span class="badge bg-success">Недельный</span>
                                    {% elif report.report_type == 'monthly' %}
                                        <span class="badge bg-warning">Месячный</span>
                                    {% elif report.report_type == 'custom' %}
                                        <span class="badge bg-info">Произвольный</span>
                                    {% elif report.report_type == 'export' %}
                                        <span class="badge bg-secondary">Экспорт</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if report.period_start %}
                                        {{ report.period_start }} 
                                        {% if report.period_end and report.period_end != report.period_start %}
                                            - {{ report.period_end }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Не указан</span>
                                    {% endif %}
                                </td>
                                <td>{{ report.generated_at[:16] }}</td>
                                <td>{{ report.created_by_name or 'Система' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="/api/admin/reports/{{ report.id }}/download" 
                                        class="btn btn-primary" 
                                        download 
                                        onclick="showDownloadSpinner(this)">
                                            <i class="bi bi-download"></i> Скачать
                                        </a>
                                        <button class="btn btn-danger btn-sm" onclick="deleteReport({{ report.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #6c757d;"></i>
                    <h5 class="mt-3">Нет созданных отчётов</h5>
                    <p class="text-muted">Создайте первый отчёт, используя кнопки слева</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <small class="text-muted">
                    Показано {{ reports|length }} отчётов
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Экспорт статистики -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="bi bi-download"></i> Экспорт данных
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-filetype-csv" style="font-size: 2.5rem; color: #28a745;"></i>
                        </div>
                        <h5>CSV Экспорт</h5>
                        <p class="small text-muted">Экспорт данных в формате CSV для анализа в Excel</p>
                        <div class="d-grid gap-2">
                            <a href="/api/admin/export/csv" class="btn btn-success fw-bold text-white">
                                <i class="bi bi-download"></i> Экспорт CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-filetype-xlsx" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5>Excel Экспорт</h5>
                        <p class="small text-muted">Экспорт данных в формате Excel с форматированием</p>
                        <button class="btn btn-primary fw-bold text-white" onclick="exportToExcel()">
                            <i class="bi bi-download"></i> Экспорт Excel
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-filetype-pdf" style="font-size: 2.5rem; color: #dc3545;"></i>
                        </div>
                        <h5>PDF Экспорт</h5>
                        <p class="small text-muted">Экспорт отчётов в PDF с графиками и таблицами</p>
                        <button class="btn btn-danger fw-bold text-white" onclick="exportToPDF()">
                            <i class="bi bi-download"></i> Экспорт PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-warning mt-3">
            <i class="bi bi-exclamation-triangle"></i>
            <small>
                <strong>Внимание:</strong> Экспорт больших объёмов данных может занять некоторое время. 
                Рекомендуется экспортировать данные по периодам.
            </small>
        </div>
    </div>
</div>

<!-- Модальное окно создания отчёта -->
<div class="modal fade" id="createReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-text"></i> Создание отчёта
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label">Название отчёта</label>
                        <input type="text" class="form-control" id="reportName" 
                               placeholder="Например: Отчёт за январь 2025">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Тип отчёта</label>
                        <select class="form-select" id="reportType" onchange="toggleDateFields()">
                            <option value="daily">Дневной</option>
                            <option value="weekly">Недельный</option>
                            <option value="monthly">Месячный</option>
                            <option value="custom">Произвольный период</option>
                        </select>
                    </div>
                    
                    <div class="row" id="dateFields" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Дата начала</label>
                            <input type="date" class="form-control" id="dateStart">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Дата окончания</label>
                            <input type="date" class="form-control" id="dateEnd">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Формат экспорта</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV</option>
                            <option value="excel">Excel (XLSX)</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            Дневной отчёт содержит события за сегодняшний день.<br>
                            Недельный отчёт - за последние 7 дней.<br>
                            Месячный отчёт - за текущий месяц.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createReport()">
                    <i class="bi bi-file-earmark-plus"></i> Создать
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно экспорта -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-download"></i> Экспорт данных
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="exportContent">
                    <!-- Контент для экспорта будет загружен здесь -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="exportDownloadBtn">
                    <i class="bi bi-download"></i> Скачать
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Исправление для текста на кнопках в темной теме */
    [data-theme="dark"] .btn-primary,
    [data-theme="dark"] .btn-success,
    [data-theme="dark"] .btn-danger {
        color: white !important;
    }
    
    .fw-bold.text-white {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    /* PDF Export Modal Styles */
    #pdfExportModal .modal-dialog {
        max-width: 500px;
    }

    #pdfExportModal .alert-info {
        font-size: 0.9rem;
        padding: 10px;
        margin-top: 15px;
    }

    /* Notification styles */
    .alert.position-fixed {
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Показать спиннер при скачивании
    function showDownloadSpinner(link) {
        const originalHtml = link.innerHTML;
        link.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Загрузка...';
        link.disabled = true;
        
        // Через 3 секунды восстанавливаем кнопку чтоб не втыкала
        setTimeout(() => {
            link.innerHTML = originalHtml;
            link.disabled = false;
        }, 3000);
    }
    
    // Обновление списка отчётов
    function refreshReports() {
        fetch('/api/admin/reports/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateReportsTable(data.reports);
                }
            });
    }
    
    // Обновление таблицы отчётов
    function updateReportsTable(reports) {
        const tbody = document.getElementById('reportsTableBody');
        if (!tbody) return;
        
        if (reports.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="bi bi-file-earmark-text" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="mt-2 mb-0">Нет созданных отчётов</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        const html = reports.map(report => {
            let typeBadge = '';
            switch(report.report_type) {
                case 'daily': typeBadge = '<span class="badge bg-primary">Дневной</span>'; break;
                case 'weekly': typeBadge = '<span class="badge bg-success">Недельный</span>'; break;
                case 'monthly': typeBadge = '<span class="badge bg-warning">Месячный</span>'; break;
                case 'custom': typeBadge = '<span class="badge bg-info">Произвольный</span>'; break;
                case 'export': typeBadge = '<span class="badge bg-secondary">Экспорт</span>'; break;
            }
            
            const period = report.period_start ? 
                `${report.period_start}${report.period_end && report.period_end !== report.period_start ? ' - ' + report.period_end : ''}` :
                '<span class="text-muted">Не указан</span>';
            
            // Используем тот же формат кнопок, что и в оригинальном HTML
            return `
                <tr>
                    <td><strong>${report.name}</strong></td>
                    <td>${typeBadge}</td>
                    <td>${period}</td>
                    <td>${report.generated_at ? report.generated_at.slice(0, 16) : ''}</td>
                    <td>${report.created_by_name || 'Система'}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="/api/admin/reports/${report.id}/download" 
                               class="btn btn-primary" 
                               download 
                               onclick="showDownloadSpinner(this)">
                                <i class="bi bi-download"></i> Скачать
                            </a>
                            <button class="btn btn-danger btn-sm" onclick="deleteReport(${report.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = html;
    }
    
    // Показать/скрыть поля дат
    function toggleDateFields() {
        const reportType = document.getElementById('reportType').value;
        const dateFields = document.getElementById('dateFields');
        dateFields.style.display = reportType === 'custom' ? 'block' : 'none';
    }
    
    // Создание отчёта
    function createReport() {
        const reportName = document.getElementById('reportName').value || 'Отчёт';
        const reportType = document.getElementById('reportType').value;
        const exportFormat = document.getElementById('exportFormat').value;
        
        if (exportFormat === 'pdf') {
            // Для PDF используем отдельный endpoint
            const pdfData = {
                type: reportType,
                name: reportName
            };
            
            if (reportType === 'custom') {
                const dateStart = document.getElementById('dateStart').value;
                const dateEnd = document.getElementById('dateEnd').value;
                
                if (!dateStart || !dateEnd) {
                    alert('Заполните даты для произвольного периода');
                    return;
                }
                
                pdfData.period_start = dateStart;
                pdfData.period_end = dateEnd;
            }
            
            fetch('/api/admin/export/pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Ошибка сервера');
                    });
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportName.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('createReportModal'));
                modal.hide();
                
                showNotification('PDF отчет успешно создан', 'success');
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при создании PDF отчета: ' + error.message);
            });
            
            return;
        }
        
        const reportData = {
            name: reportName,
            type: reportType,
            format: exportFormat
        };
        
        if (reportType === 'custom') {
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            
            if (!dateStart || !dateEnd) {
                alert('Заполните даты для произвольного периода');
                return;
            }
            
            reportData.period_start = dateStart;
            reportData.period_end = dateEnd;
        }
        
        // Отправка запроса на создание отчёта
        fetch('/api/admin/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reportData)
        })
        .then(response => {
            if (exportFormat === 'csv') {
                return response.blob().then(blob => {
                    // Скачиваем CSV файл
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${reportName.replace(/\s+/g, '_')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Закрываем модальное окно
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createReportModal'));
                    modal.hide();
                    
                    // Обновляем список отчётов
                    refreshReports();
                });
            } else {
                return response.json().then(data => {
                    if (data.success) {
                        alert('Отчёт успешно создан');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createReportModal'));
                        modal.hide();
                        refreshReports();
                    } else {
                        alert('Ошибка: ' + data.message);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при создании отчёта');
        });
    }
    
    // Быстрое создание отчётов
    function generateReport(type) {
        let name = '';
        switch(type) {
            case 'daily': name = 'Отчёт за ' + new Date().toLocaleDateString('ru-RU'); break;
            case 'weekly': name = 'Недельный отчёт'; break;
            case 'monthly': name = 'Месячный отчёт'; break;
        }
        
        fetch('/api/admin/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: type,
                name: name
            })
        })
        .then(response => response.blob())
        .then(blob => {
            // Скачиваем файл
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/\s+/g, '_')}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Обновляем список отчётов
            setTimeout(refreshReports, 1000);
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при создании отчёта');
        });
    }
    
    // Удаление отчёта
    function deleteReport(reportId) {
        if (confirm('Вы уверены, что хотите удалить этот отчёт?')) {
            fetch(`/api/admin/reports/${reportId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка соединения с сервером');
            });
        }
    }
    
    // Экспорт в Excel
    function exportToExcel() {
        fetch('/api/admin/export/excel')
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `askud_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Экспорт в Excel будет доступен после установки дополнительных библиотек');
            });
    }
    
    // Экспорт в PDF
    function exportToPDF() {
        // Показать модальное окно с настройками PDF
        const modalHtml = `
            <div class="modal fade" id="pdfExportModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-filetype-pdf"></i> Экспорт в PDF
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Тип отчета</label>
                                <select class="form-select" id="pdfReportType">
                                    <option value="events">Детальный отчет по событиям</option>
                                    <option value="summary">Сводный отчет</option>
                                </select>
                            </div>
                            
                            <div id="pdfEventsOptions">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Дата начала</label>
                                        <input type="date" class="form-control" id="pdfDateStart" 
                                               value="${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Дата окончания</label>
                                        <input type="date" class="form-control" id="pdfDateEnd" 
                                               value="${new Date().toISOString().split('T')[0]}">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Название отчета</label>
                                    <input type="text" class="form-control" id="pdfReportName" 
                                           value="Отчет АСКУД">
                                </div>
                            </div>
                            
                            <div id="pdfSummaryOptions" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Период анализа (дней)</label>
                                    <select class="form-select" id="pdfPeriod">
                                        <option value="7">7 дней</option>
                                        <option value="30" selected>30 дней</option>
                                        <option value="90">90 дней</option>
                                        <option value="180">180 дней</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <small>
                                    <strong>Детальный отчет</strong> - содержит список всех событий доступа за период.<br/>
                                    <strong>Сводный отчет</strong> - содержит статистику и аналитику по системе.
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-primary" onclick="generatePDF()">
                                <i class="bi bi-download"></i> Создать PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Добавляем модальное окно на страницу
        if (!document.getElementById('pdfExportModal')) {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('pdfExportModal'));
        modal.show();
        
        // Обработчик изменения типа отчета
        document.getElementById('pdfReportType').addEventListener('change', function() {
            const isSummary = this.value === 'summary';
            document.getElementById('pdfEventsOptions').style.display = isSummary ? 'none' : 'block';
            document.getElementById('pdfSummaryOptions').style.display = isSummary ? 'block' : 'none';
        });
    }

    function generatePDF() {
        const reportType = document.getElementById('pdfReportType').value;
        const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfExportModal'));
        
        let url, data;
        
        if (reportType === 'events') {
            const dateStart = document.getElementById('pdfDateStart').value;
            const dateEnd = document.getElementById('pdfDateEnd').value;
            const reportName = document.getElementById('pdfReportName').value || 'Отчет АСКУД';
            
            if (!dateStart || !dateEnd) {
                alert('Заполните даты периода');
                return;
            }
            
            if (new Date(dateStart) > new Date(dateEnd)) {
                alert('Дата начала не может быть позже даты окончания');
                return;
            }
            
            // Используем HTML-based PDF для лучшей поддержки Unicode
            url = '/api/admin/export/pdf/html';  // или '/api/admin/export/pdf/pdfkit'
            data = {
                type: 'custom',
                name: reportName,
                period_start: dateStart,
                period_end: dateEnd
            };
        } else {
            const period = document.getElementById('pdfPeriod').value;
            
            url = '/api/admin/export/pdf/summary';
            data = {
                period: period
            };
        }
        
        // Показываем индикатор загрузки
        const button = document.querySelector('#pdfExportModal .btn-primary');
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Генерация...';
        button.disabled = true;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.message || 'Ошибка сервера');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // Проверяем, что это действительно PDF
            if (blob.type !== 'application/pdf' && !blob.type.includes('pdf')) {
                throw new Error('Получен некорректный файл');
            }
            
            // Создаем URL для скачивания
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            if (reportType === 'events') {
                const reportName = document.getElementById('pdfReportName').value || 'Отчет АСКУД';
                a.download = `${reportName.replace(/\s+/g, '_')}.pdf`;
            } else {
                const period = document.getElementById('pdfPeriod').value;
                a.download = `summary_report_${period}_days.pdf`;
            }
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Восстанавливаем кнопку
            button.innerHTML = originalText;
            button.disabled = false;
            
            // Закрываем модальное окно
            pdfModal.hide();
            
            // Показываем уведомление об успехе
            showNotification('PDF отчет успешно создан и скачан', 'success');
        })
        .catch(error => {
            console.error('Ошибка:', error);
            
            // Восстанавливаем кнопку
            button.innerHTML = originalText;
            button.disabled = false;
            
            alert('Ошибка при создании PDF: ' + error.message);
        });
    }

    // Вспомогательная функция для уведомлений
    function showNotification(message, type = 'info') {
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'info': 'alert-info',
            'warning': 'alert-warning'
        }[type];
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Автоматически скрываем через 5 секунд
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Установим сегодняшнюю дату как значение по умолчанию
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        document.getElementById('dateStart').value = weekAgo;
        document.getElementById('dateEnd').value = today;
        
        // Установим название отчёта по умолчанию
        document.getElementById('reportName').value = 'Отчёт от ' + new Date().toLocaleDateString('ru-RU');
        
        // Обновляем список отчётов каждые 30 секунд
        setInterval(refreshReports, 30000);
    });
</script>
{% endblock %}