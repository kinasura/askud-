{% extends "admin_base.html" %}

{% block title %}Управление правами доступа - АСКУД Админ{% endblock %}

{% block page_title %}Управление правами доступа{% endblock %}
{% block page_subtitle %}Настройка расписания доступа сотрудников к лабораториям{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> Сотрудники
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="employeesList">
                    {% for employee in employees %}
                    <a href="#" class="list-group-item list-group-item-action employee-item" 
                       data-id="{{ employee.id }}">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ employee.full_name }}</h6>
                                <small class="text-muted">{{ employee.department or 'Без отдела' }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary rounded-pill">
                                    {{ employee.accessible_labs_count or 0 }}
                                </span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small>
                                <i class="bi bi-key"></i> PIN: {{ employee.pin_code }} | 
                                <i class="bi bi-person"></i> {{ employee.login }}
                            </small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    Всего сотрудников: {{ employees|length }}
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-check"></i> Расписание доступа
                </h5>
                <button class="btn btn-primary btn-sm" id="addScheduleBtn" disabled>
                    <i class="bi bi-plus-circle"></i> Добавить расписание
                </button>
            </div>
            <div class="card-body">
                <!-- Состояние: сотрудник не выбран -->
                <div id="noEmployeeSelected" class="text-center py-5">
                    <i class="bi bi-person-lines-fill" style="font-size: 4rem; color: #6c757d;"></i>
                    <h4 class="mt-3">Выберите сотрудника</h4>
                    <p class="text-muted">Выберите сотрудника из списка слева для просмотра и редактирования его расписания доступа</p>
                </div>

                <!-- Состояние: расписание сотрудника -->
                <div id="employeeSchedule" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h5 id="employeeName" class="mb-1"></h5>
                            <p class="text-muted mb-0" id="employeeInfo"></p>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshSchedule()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Таблица расписания -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Лаборатория</th>
                                    <th>Дни недели</th>
                                    <th>Время доступа</th>
                                    <th>Длительность</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <!-- Данные загружаются через JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            Сотрудник имеет доступ только в указанные дни и время. 
                            Для добавления доступа в другие дни используйте кнопку "Добавить расписание".
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления/редактирования расписания -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Добавление расписания доступа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId">
                    <input type="hidden" id="employeeId">
                    
                    <div class="mb-3">
                        <label class="form-label">Лаборатория *</label>
                        <select class="form-select" id="laboratoryId" required>
                            <option value="">Выберите лабораторию</option>
                            {% for lab in laboratories %}
                            <option value="{{ lab.id }}">{{ lab.name }} ({{ lab.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Дни недели *</label>
                        <div class="row">
                            {% for day_index, day_name in [('0', 'Понедельник'), ('1', 'Вторник'), ('2', 'Среда'), ('3', 'Четверг'), ('4', 'Пятница'), ('5', 'Суббота'), ('6', 'Воскресенье')] %}
                            <div class="col-4">
                                <div class="form-check">
                                    <input class="form-check-input day-checkbox" type="checkbox" value="{{ day_index }}" id="day{{ day_index }}">
                                    <label class="form-check-label" for="day{{ day_index }}">
                                        {{ day_name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Время начала *</label>
                            <input type="time" class="form-control" id="timeStart" 
                                   value="08:00" min="00:00" max="23:59" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Время окончания *</label>
                            <input type="time" class="form-control" id="timeEnd" 
                                   value="18:00" min="00:00" max="23:59" required>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <small>
                            Обратите внимание: время окончания должно быть больше времени начала. 
                            Для круглосуточного доступа укажите время с 00:00 до 23:59.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveScheduleBtn">
                    <span id="saveBtnText">Сохранить</span>
                    <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentEmployeeId = null;
    let currentEmployeeName = '';
    
    // Названия дней недели
    const daysOfWeek = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
    
    // Загрузка расписания сотрудника
    function loadEmployeeSchedule(employeeId, employeeName, employeeInfo) {
        currentEmployeeId = employeeId;
        currentEmployeeName = employeeName;
        
        // Показываем блок с расписанием
        document.getElementById('noEmployeeSelected').style.display = 'none';
        document.getElementById('employeeSchedule').style.display = 'block';
        
        // Обновляем информацию о сотруднике
        document.getElementById('employeeName').textContent = employeeName;
        document.getElementById('employeeInfo').textContent = employeeInfo;
        
        // Активируем кнопку добавления
        document.getElementById('addScheduleBtn').disabled = false;
        
        // Загружаем расписание
        refreshSchedule();
    }
    
    // Обновление расписания
    function refreshSchedule() {
        if (!currentEmployeeId) return;
        
        // Показываем индикатор загрузки
        const tbody = document.getElementById('scheduleTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm me-2"></div>Загрузка...</td></tr>';
        
        fetch(`/api/admin/employees/${currentEmployeeId}/access`)
            .then(response => {
                if (response.status === 404) {
                    throw new Error('Сотрудник не найден');
                }
                if (response.status === 403) {
                    throw new Error('Нет доступа');
                }
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('scheduleTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.access_rights && data.access_rights.length > 0) {
                        data.access_rights.forEach(schedule => {
                            // Вычисляем длительность
                            const start = schedule.time_start;
                            const end = schedule.time_end;
                            const duration = calculateDuration(start, end);
                            
                            // Форматируем дни недели
                            let dayNames = 'Не указаны';
                            if (schedule.days_of_week) {
                                try {
                                    let daysArray;
                                    if (Array.isArray(schedule.days_of_week)) {
                                        daysArray = schedule.days_of_week;
                                    } else if (typeof schedule.days_of_week === 'string') {
                                        // Убираем возможные кавычки и скобки
                                        let cleanStr = schedule.days_of_week.trim();
                                        if (cleanStr.startsWith('[') && cleanStr.endsWith(']')) {
                                            cleanStr = cleanStr.slice(1, -1);
                                        }
                                        if (cleanStr.startsWith('"') && cleanStr.endsWith('"')) {
                                            cleanStr = cleanStr.slice(1, -1);
                                        }
                                        daysArray = cleanStr.split(',');
                                    } else {
                                        daysArray = [];
                                    }
                                    
                                    dayNames = daysArray
                                        .map(dayNum => {
                                            const dayIndex = parseInt(dayNum.toString().trim());
                                            return !isNaN(dayIndex) && dayIndex >= 0 && dayIndex < 7 ? 
                                                daysOfWeek[dayIndex] : '';
                                        })
                                        .filter(Boolean)
                                        .join(', ');
                                } catch (error) {
                                    console.error('Ошибка при форматировании дней недели:', error);
                                    dayNames = 'Ошибка данных';
                                }
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <strong>${escapeHtml(schedule.laboratory_name || 'Неизвестно')}</strong><br>
                                    <small class="text-muted">${escapeHtml(schedule.laboratory_code || '')}</small>
                                </td>
                                <td>${escapeHtml(dayNames)}</td>
                                <td>
                                    <span class="badge bg-primary">${escapeHtml(start || '')}</span> - 
                                    <span class="badge bg-secondary">${escapeHtml(end || '')}</span>
                                </td>
                                <td>${escapeHtml(duration || '0 час.')}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1 edit-schedule-btn" 
                                            data-id="${schedule.id}"
                                            data-lab-id="${schedule.laboratory_id}"
                                            data-days='${JSON.stringify(schedule.days_of_week || [])}'
                                            data-start="${start || ''}"
                                            data-end="${end || ''}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-schedule-btn" 
                                            data-id="${schedule.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        // Добавляем обработчики событий для новых кнопок
                        document.querySelectorAll('.edit-schedule-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const scheduleId = parseInt(this.getAttribute('data-id'));
                                const labId = parseInt(this.getAttribute('data-lab-id'));
                                const daysStr = this.getAttribute('data-days');
                                const start = this.getAttribute('data-start');
                                const end = this.getAttribute('data-end');
                                editSchedule(scheduleId, labId, daysStr, start, end);
                            });
                        });
                        
                        document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const scheduleId = parseInt(this.getAttribute('data-id'));
                                deleteSchedule(scheduleId);
                            });
                        });
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="bi bi-calendar-x" style="font-size: 2rem; color: #6c757d;"></i>
                                    <p class="mt-2 mb-0">У сотрудника нет настроенного расписания</p>
                                    <small class="text-muted">Добавьте расписание доступа, используя кнопку выше</small>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    showError('Ошибка загрузки расписания: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p class="mt-2 mb-0">Ошибка загрузки данных</p>
                            <small>${escapeHtml(error.message)}</small>
                        </td>
                    </tr>
                `;
                showError('Ошибка загрузки расписания: ' + error.message);
            });
    }
    
    // Вычисление длительности
    function calculateDuration(start, end) {
        const startTime = new Date(`2000-01-01T${start}`);
        const endTime = new Date(`2000-01-01T${end}`);
        
        let diff = endTime - startTime;
        if (diff < 0) diff += 24 * 60 * 60 * 1000; // Если переход через полночь
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (hours === 24 && minutes === 0) {
            return '24 часа';
        } else if (hours === 0) {
            return `${minutes} мин.`;
        } else if (minutes === 0) {
            return `${hours} час.`;
        } else {
            return `${hours} час. ${minutes} мин.`;
        }
    }
    
    // Редактирование расписания
    function editSchedule(scheduleId, labId, daysStr, start, end) {
        document.getElementById('modalTitle').textContent = 'Редактирование расписания';
        document.getElementById('scheduleId').value = scheduleId;
        document.getElementById('employeeId').value = currentEmployeeId;
        document.getElementById('laboratoryId').value = labId;
        document.getElementById('timeStart').value = start;
        document.getElementById('timeEnd').value = end;
        
        // Сбрасываем все чекбоксы
        document.querySelectorAll('.day-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Устанавливаем выбранные дни
        let daysArray = [];
        try {
            if (daysStr && daysStr.trim() !== '') {
                daysArray = JSON.parse(daysStr);
                if (!Array.isArray(daysArray)) {
                    daysArray = [];
                }
            }
        } catch (e) {
            console.error('Ошибка парсинга дней недели:', e);
            daysArray = [];
        }
        
        // Отмечаем чекбоксы
        daysArray.forEach(day => {
            const checkbox = document.querySelector(`.day-checkbox[value="${day}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        
        const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        modal.show();
    }
    
    // Удаление расписания
    function deleteSchedule(scheduleId) {
        if (confirm('Вы уверены, что хотите удалить это расписание доступа?')) {
            fetch(`/api/admin/employees/${currentEmployeeId}/access/${scheduleId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Расписание удалено');
                    refreshSchedule();
                } else {
                    showError('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showError('Ошибка соединения с сервером');
            });
        }
    }
    
    // Показать сообщение об успехе
    function showSuccess(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>${escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        const container = document.querySelector('.container-fluid') || document.querySelector('main') || document.body;
        if (container) {
            container.prepend(alert);
        }
        
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 3000);
    }
    
    // Показать сообщение об ошибке
    function showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="bi bi-exclamation-triangle me-2"></i>${escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        const container = document.querySelector('.container-fluid') || document.querySelector('main') || document.body;
        if (container) {
            container.prepend(alert);
        }
    }
    
    // Экранирование HTML для предотвращения XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
        // Обработка выбора сотрудника
        document.querySelectorAll('.employee-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Убираем активный класс у всех элементов
                document.querySelectorAll('.employee-item').forEach(i => {
                    i.classList.remove('active');
                });
                
                // Добавляем активный класс выбранному элементу
                this.classList.add('active');
                
                // Получаем данные сотрудника
                const employeeId = this.dataset.id;
                const employeeName = this.querySelector('h6').textContent;
                const employeeInfo = this.querySelector('.text-muted').textContent;
                
                // Загружаем расписание сотрудника
                loadEmployeeSchedule(employeeId, employeeName, employeeInfo);
            });
        });
        
        // Кнопка добавления расписания
        document.getElementById('addScheduleBtn').addEventListener('click', function() {
            if (!currentEmployeeId) {
                alert('Выберите сотрудника');
                return;
            }
            
            // Сброс формы
            document.getElementById('scheduleForm').reset();
            document.getElementById('modalTitle').textContent = 'Добавление расписания доступа';
            document.getElementById('employeeId').value = currentEmployeeId;
            document.getElementById('scheduleId').value = '';
            document.getElementById('timeStart').value = '08:00';
            document.getElementById('timeEnd').value = '18:00';
            
            // Сбрасываем все чекбоксы дней
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Показ модального окна
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            modal.show();
        });
        
        // Сохранение расписания
        document.getElementById('saveScheduleBtn').addEventListener('click', function() {
            const scheduleId = document.getElementById('scheduleId').value;
            const employeeId = document.getElementById('employeeId').value;
            
            // Собираем выбранные дни недели
            const selectedDays = [];
            document.querySelectorAll('.day-checkbox:checked').forEach(checkbox => {
                selectedDays.push(parseInt(checkbox.value));
            });
            
            const scheduleData = {
                laboratory_id: parseInt(document.getElementById('laboratoryId').value),
                days_of_week: selectedDays,
                time_start: document.getElementById('timeStart').value,
                time_end: document.getElementById('timeEnd').value
            };
            
            // Валидация
            if (!scheduleData.laboratory_id) {
                alert('Выберите лабораторию');
                return;
            }
            
            if (scheduleData.days_of_week.length === 0) {
                alert('Выберите хотя бы один день недели');
                return;
            }
            
            // Проверка времени
            if (scheduleData.time_start >= scheduleData.time_end) {
                alert('Время окончания должно быть больше времени начала');
                return;
            }
            
            // Дополнительная проверка на одинаковое время
            const startTime = new Date(`2000-01-01T${scheduleData.time_start}`);
            const endTime = new Date(`2000-01-01T${scheduleData.time_end}`);
            let diff = endTime - startTime;
            if (diff < 0) diff += 24 * 60 * 60 * 1000;

            if (diff === 0) {
                alert('Время начала и окончания не могут быть одинаковыми');
                return;
            }
            
            // Показать спиннер
            const saveBtn = document.getElementById('saveScheduleBtn');
            const saveText = document.getElementById('saveBtnText');
            const spinner = document.getElementById('saveSpinner');
            
            saveText.classList.add('d-none');
            spinner.classList.remove('d-none');
            saveBtn.disabled = true;
            
            // Определяем URL и метод
            let url, method;
            if (scheduleId) {
                // Для редактирования существующего расписания
                url = `/api/admin/access_rule/${scheduleId}`;
                method = 'PUT';
            } else {
                // Для создания нового расписания
                url = `/api/admin/employees/${employeeId}/access`;
                method = 'POST';
            }
            
            // Отправка запроса
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Скрыть спиннер
                saveText.classList.remove('d-none');
                spinner.classList.add('d-none');
                saveBtn.disabled = false;
                
                if (data.success) {
                    // Закрываем модальное окно
                    const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Показываем сообщение об успехе
                    showSuccess(scheduleId ? 'Расписание обновлено' : 'Расписание добавлено');
                    
                    // Обновляем расписание
                    refreshSchedule();
                } else {
                    showError('Ошибка: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                
                // Скрыть спиннер
                saveText.classList.remove('d-none');
                spinner.classList.add('d-none');
                saveBtn.disabled = false;
                
                showError('Ошибка соединения с сервером: ' + error.message);
            });
        });
    });
</script>
{% endblock %}